# ======================================================================
# IMPORTANT: Create a .env file before running this!
# ======================================================================
# Copy .env.example to .env and fill in your values:
#   cp .env.example .env
#   nano .env
# 
# Minimum required variables in .env:
#   - POSTGRES_PASSWORD (database password)
#   - DISCORD_CLIENT_ID (from Discord Developer Portal)
#   - DISCORD_CLIENT_SECRET (from Discord Developer Portal)
#   - DISCORD_BOT_TOKEN (from Discord Developer Portal)
#   - DISCORD_APP_ID (from Discord Developer Portal)
#   - SESSION_SECRET (generate with: openssl rand -base64 32)
#   - PUBLIC_DOMAIN (your server domain)
#   - DISCORD_CALLBACK_URL (your OAuth callback URL)
#
# See QUICKSTART.md for detailed instructions.
# ======================================================================

services:
  # PostgreSQL Database
  postgres:
    image: postgres:16-alpine
    container_name: discord-bot-db
    restart: unless-stopped
    environment:
      POSTGRES_DB: ticketbot
      POSTGRES_USER: ticketbot
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    # Port 5432 is only accessible within the Docker network (not exposed to host)
    # This prevents conflicts with existing PostgreSQL installations
    networks:
      - bot-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ticketbot -d ticketbot"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    labels:
      # Homelabhub Integration
      - "homelabhub.enable=true"
      - "homelabhub.group=discord-bot"
      - "homelabhub.name=Discord Bot Database"
      - "homelabhub.description=PostgreSQL database for Discord ticket bot"
      - "homelabhub.icon=database"
      - "homelabhub.category=database"
      - "homelabhub.importance=critical"

  # Discord Bot Application
  bot:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: discord-bot-app
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    dns:
      - 8.8.8.8
      - 8.8.4.4
    environment:
      # Database - connects via service name using bridge network
      DATABASE_URL: "postgresql://ticketbot:${POSTGRES_PASSWORD}@postgres:5432/ticketbot"

      # Discord Configuration
      DISCORD_BOT_TOKEN: ${DISCORD_BOT_TOKEN}
      DISCORD_CLIENT_ID: ${DISCORD_CLIENT_ID}
      DISCORD_CLIENT_SECRET: ${DISCORD_CLIENT_SECRET}
      DISCORD_APP_ID: ${DISCORD_APP_ID}
      VITE_DISCORD_CLIENT_ID: ${VITE_DISCORD_CLIENT_ID}

      # OAuth and Domain Configuration
      DISCORD_CALLBACK_URL: ${DISCORD_CALLBACK_URL}
      APP_URL: ${APP_URL:-${PUBLIC_DOMAIN:-http://localhost:5000}}
      PUBLIC_DOMAIN: ${PUBLIC_DOMAIN:-http://localhost:5000}
      VITE_CUSTOM_WS_URL: ${VITE_CUSTOM_WS_URL}

      # Session Configuration
      SESSION_SECRET: ${SESSION_SECRET}

      # Spotify Configuration (Optional - for playlist import)
      SPOTIFY_CLIENT_ID: ${SPOTIFY_CLIENT_ID:-}
      SPOTIFY_CLIENT_SECRET: ${SPOTIFY_CLIENT_SECRET:-}

      # Discord Server Invite Link (for users to join your Discord server)
      # Example: https://discord.gg/abc123
      DISCORD_SERVER_INVITE_URL: ${DISCORD_SERVER_INVITE_URL:-}

      # Application Settings
      NODE_ENV: production
      PORT: 5000
      
      # Database Reset Flag (set to 'true' to reset database on startup)
      RESET_DB: ${RESET_DB:-false}
    volumes:
      - ./attached_assets:/app/attached_assets
      - ./logs:/app/logs
    networks:
      - bot-network
    ports:
      - "5000:5000"
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:5000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    labels:
      # Homelabhub Integration
      - "homelabhub.enable=true"
      - "homelabhub.group=discord-bot"
      - "homelabhub.name=Discord Ticket Bot"
      - "homelabhub.description=Discord bot for support ticket management"
      - "homelabhub.icon=discord"
      - "homelabhub.category=application"
      - "homelabhub.importance=critical"
      # Service endpoints for homelabhub
      - "homelabhub.web.url=https://bot.evindrake.net"
      - "homelabhub.web.port=5000"
      - "homelabhub.web.protocol=https"
      # Health and metrics endpoints
      - "homelabhub.health.endpoint=/health"
      - "homelabhub.metrics.endpoint=/api/homelabhub/metrics"
      - "homelabhub.control.endpoint=/api/homelabhub/control"
      # Display information
      - "homelabhub.display.status=online"
      - "homelabhub.display.version=1.0.0"
      - "homelabhub.display.uptime=true"
      - "homelabhub.display.stats=true"

networks:
  bot-network:
    driver: bridge

volumes:
  postgres_data:
    driver: local