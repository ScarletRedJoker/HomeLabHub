{% extends "base.html" %}

{% block title %}Plex Media Import - Nebula Command{% endblock %}

{% block head %}
<style>
.plex-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
    gap: 1rem;
}
.plex-header h2 {
    margin: 0;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-size: 1.5rem;
}
.plex-header h2 i {
    color: #e5a00d;
}
.upload-zone {
    border: 2px dashed rgba(229, 160, 13, 0.4);
    border-radius: 12px;
    padding: 3rem 2rem;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    background: rgba(229, 160, 13, 0.05);
}
.upload-zone:hover,
.upload-zone.dragover {
    border-color: #e5a00d;
    background: rgba(229, 160, 13, 0.12);
}
.upload-zone .upload-icon {
    font-size: 3.5rem;
    color: #e5a00d;
    margin-bottom: 1rem;
}
.upload-zone h4 {
    margin-bottom: 0.5rem;
    font-weight: 600;
}
.upload-zone p {
    color: var(--text-muted);
    margin-bottom: 1rem;
}
.card {
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    overflow: hidden;
}
.card-header {
    background: rgba(0,0,0,0.2);
    padding: 1rem 1.25rem;
    border-bottom: 1px solid var(--border-color);
    display: flex;
    align-items: center;
    justify-content: space-between;
}
.card-header h5, .card-header h6 {
    margin: 0;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}
.card-body {
    padding: 1.25rem;
}
.info-section h6 {
    color: #e5a00d;
    font-size: 0.85rem;
    margin-bottom: 0.5rem;
    font-weight: 600;
}
.info-section ul, .info-section ol {
    padding-left: 1.25rem;
    margin-bottom: 1rem;
}
.info-section li {
    font-size: 0.85rem;
    color: var(--text-muted);
    margin-bottom: 0.25rem;
}
.library-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem;
    background: rgba(0,0,0,0.2);
    border-radius: 8px;
    margin-bottom: 0.5rem;
}
.library-item:last-child {
    margin-bottom: 0;
}
.library-icon {
    width: 36px;
    height: 36px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1rem;
}
.library-icon.movie { background: linear-gradient(135deg, #e5a00d, #cc8a00); }
.library-icon.show { background: linear-gradient(135deg, #8b5cf6, #6d28d9); }
.library-icon.artist { background: linear-gradient(135deg, #10b981, #059669); }
.library-icon.photo { background: linear-gradient(135deg, #3b82f6, #2563eb); }
.library-info {
    flex: 1;
}
.library-info strong {
    display: block;
    font-size: 0.9rem;
}
.library-info small {
    color: var(--text-muted);
    text-transform: capitalize;
}
.plex-status {
    padding: 1rem;
    border-radius: 8px;
    text-align: center;
}
.plex-status.connected {
    background: rgba(16, 185, 129, 0.1);
    border: 1px solid rgba(16, 185, 129, 0.3);
}
.plex-status.disconnected {
    background: rgba(239, 68, 68, 0.1);
    border: 1px solid rgba(239, 68, 68, 0.3);
}
.plex-status i {
    font-size: 1.5rem;
    margin-bottom: 0.5rem;
    display: block;
}
.plex-status.connected i { color: #10b981; }
.plex-status.disconnected i { color: #ef4444; }
.selected-files-list {
    max-height: 200px;
    overflow-y: auto;
}
.file-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.75rem 1rem;
    background: rgba(0,0,0,0.2);
    border-radius: 8px;
    margin-bottom: 0.5rem;
}
.file-item:last-child {
    margin-bottom: 0;
}
.file-info {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    flex: 1;
    min-width: 0;
}
.file-info i {
    color: #e5a00d;
    font-size: 1.25rem;
}
.file-details {
    min-width: 0;
}
.file-details strong {
    display: block;
    font-size: 0.9rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
.file-details small {
    color: var(--text-muted);
}
.jobs-table {
    width: 100%;
}
.jobs-table th {
    font-weight: 600;
    font-size: 0.85rem;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    padding: 0.75rem 1rem;
    border-bottom: 1px solid var(--border-color);
    text-align: left;
}
.jobs-table td {
    padding: 0.75rem 1rem;
    border-bottom: 1px solid var(--border-color);
    vertical-align: middle;
}
.jobs-table tr:last-child td {
    border-bottom: none;
}
.empty-state {
    text-align: center;
    padding: 3rem 1rem;
    color: var(--text-muted);
}
.empty-state i {
    font-size: 3rem;
    margin-bottom: 1rem;
    opacity: 0.5;
}
.progress {
    height: 8px;
    background: rgba(0,0,0,0.3);
    border-radius: 4px;
    overflow: hidden;
}
.progress-bar {
    height: 100%;
    border-radius: 4px;
    transition: width 0.3s ease;
}
.upload-progress-container {
    background: rgba(0,0,0,0.2);
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1rem;
}
.upload-progress-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.75rem;
}
.media-type-select {
    margin-bottom: 1.5rem;
}
.media-type-select label {
    font-weight: 500;
    margin-bottom: 0.5rem;
    display: block;
}
.media-type-select .form-select {
    max-width: 300px;
}
@media (max-width: 991px) {
    .plex-header {
        flex-direction: column;
        align-items: flex-start;
    }
    .upload-zone {
        padding: 2rem 1rem;
    }
    .upload-zone .upload-icon {
        font-size: 2.5rem;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="plex-header">
        <h2><i class="bi bi-film"></i> Plex Media Import</h2>
        <button class="btn btn-primary btn-sm" onclick="refreshJobs()">
            <i class="bi bi-arrow-clockwise"></i> Refresh
        </button>
    </div>

    <div class="row g-4">
        <div class="col-lg-8">
            <div class="card mb-4">
                <div class="card-header">
                    <h5><i class="bi bi-cloud-upload"></i> Upload Media</h5>
                </div>
                <div class="card-body">
                    <div id="dropZone" class="upload-zone" onclick="document.getElementById('fileInput').click()">
                        <i class="bi bi-film upload-icon"></i>
                        <h4>Drag & Drop Media Files</h4>
                        <p>or click to browse your computer</p>
                        <input type="file" id="fileInput" class="d-none" multiple accept="video/*,audio/*">
                        <button class="btn btn-primary" onclick="event.stopPropagation(); document.getElementById('fileInput').click()">
                            <i class="bi bi-folder2-open me-2"></i>Browse Files
                        </button>
                    </div>

                    <div id="selectedFilesSection" style="display: none;" class="mt-4">
                        <div class="media-type-select">
                            <label for="mediaTypeSelect">Media Type</label>
                            <select id="mediaTypeSelect" class="form-select">
                                <option value="" selected>Auto-detect from filename</option>
                                <option value="movie">Movie</option>
                                <option value="tv_show">TV Show</option>
                                <option value="music">Music</option>
                            </select>
                        </div>

                        <label class="form-label fw-semibold">Selected Files</label>
                        <div id="fileList" class="selected-files-list"></div>
                    </div>

                    <div id="uploadProgress" style="display: none;" class="mt-4">
                        <div class="upload-progress-container">
                            <div class="upload-progress-header">
                                <span id="uploadStatusText">Uploading...</span>
                                <button id="cancelUploadBtn" class="btn btn-outline-danger btn-sm" onclick="cancelCurrentUpload()" style="display: none;">
                                    <i class="bi bi-x-circle"></i> Cancel
                                </button>
                            </div>
                            <div class="progress">
                                <div id="progressBar" class="progress-bar bg-success" style="width: 0%"></div>
                            </div>
                            <small id="uploadStatus" class="text-muted mt-2 d-block"></small>
                        </div>
                    </div>

                    <button id="uploadBtn" class="btn btn-success btn-lg w-100 mt-3" disabled onclick="startUpload()">
                        <i class="bi bi-upload me-2"></i>Upload and Import
                    </button>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h5><i class="bi bi-list-task"></i> Import Jobs</h5>
                    <button class="btn btn-outline-danger btn-sm" onclick="cleanupOldJobs()">
                        <i class="bi bi-trash"></i> Cleanup
                    </button>
                </div>
                <div class="card-body p-0">
                    <div id="jobsLoading" class="text-center py-5">
                        <div class="spinner-border spinner-border-sm text-primary"></div>
                        <span class="ms-2 text-muted">Loading jobs...</span>
                    </div>

                    <div id="jobsContent" style="display: none;">
                        <div class="table-responsive">
                            <table class="jobs-table">
                                <thead>
                                    <tr>
                                        <th>Job</th>
                                        <th>Type</th>
                                        <th>Status</th>
                                        <th>Progress</th>
                                        <th>Created</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody id="jobsTableBody"></tbody>
                            </table>
                        </div>
                        <div id="noJobs" class="empty-state" style="display: none;">
                            <i class="bi bi-inbox"></i>
                            <p>No import jobs yet</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card mb-4">
                <div class="card-header">
                    <h6><i class="bi bi-server"></i> Plex Connection</h6>
                </div>
                <div class="card-body">
                    <div id="plexStatus">
                        <div class="text-center py-3">
                            <div class="spinner-border spinner-border-sm text-primary"></div>
                            <small class="d-block mt-2 text-muted">Checking connection...</small>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card mb-4">
                <div class="card-header">
                    <h6><i class="bi bi-collection"></i> Libraries</h6>
                    <button class="btn btn-outline-primary btn-sm" onclick="triggerManualScan()" title="Scan Libraries">
                        <i class="bi bi-arrow-repeat"></i>
                    </button>
                </div>
                <div class="card-body">
                    <div id="librariesList">
                        <div class="text-center py-3">
                            <div class="spinner-border spinner-border-sm text-primary"></div>
                            <small class="d-block mt-2 text-muted">Loading...</small>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h6><i class="bi bi-info-circle"></i> Import Guide</h6>
                </div>
                <div class="card-body info-section">
                    <h6>Supported Formats</h6>
                    <ul>
                        <li>Videos: .mp4, .mkv, .avi, .mov</li>
                        <li>Music: .mp3, .flac, .m4a, .wav</li>
                    </ul>

                    <h6>Naming Conventions</h6>
                    <ul>
                        <li><strong>Movies:</strong> Movie Name (2020).mp4</li>
                        <li><strong>TV Shows:</strong> Show Name S01E01.mp4</li>
                    </ul>

                    <h6>How It Works</h6>
                    <ol>
                        <li>Upload files to staging area</li>
                        <li>Metadata extracted from filename</li>
                        <li>Files organized into Plex folders</li>
                        <li>Library automatically scanned</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="jobDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-info-circle me-2"></i>Job Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="jobDetailsContent"></div>
        </div>
    </div>
</div>

<div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="successToast" class="toast align-items-center text-white bg-success border-0" role="alert">
        <div class="d-flex">
            <div class="toast-body"></div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    </div>
    <div id="errorToast" class="toast align-items-center text-white bg-danger border-0" role="alert">
        <div class="d-flex">
            <div class="toast-body"></div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    </div>
</div>

<script>
let selectedFiles = [];
let uploadConfig = null;
let currentUpload = null;
const CHUNKED_UPLOAD_THRESHOLD = 50 * 1024 * 1024;

document.addEventListener('DOMContentLoaded', function() {
    loadUploadConfig();
    setupDropZone();
    setupFileInput();
    loadJobs();
    loadLibraries();
    checkPlexConnection();
    setInterval(refreshJobs, 10000);
});

async function loadUploadConfig() {
    try {
        const response = await fetch('/api/plex/upload/config');
        const data = await response.json();
        if (data.success) {
            uploadConfig = data;
        }
    } catch (error) {
        uploadConfig = {
            max_file_size: 10 * 1024 * 1024 * 1024,
            chunk_size: 10 * 1024 * 1024,
            allowed_extensions: ['mp4', 'mkv', 'avi', 'mov', 'mp3', 'flac']
        };
    }
}

function checkPlexConnection() {
    fetch('/api/plex/libraries')
        .then(r => r.json())
        .then(data => {
            const container = document.getElementById('plexStatus');
            if (data.success) {
                container.innerHTML = `
                    <div class="plex-status connected">
                        <i class="bi bi-check-circle-fill"></i>
                        <strong>Connected</strong>
                        <small class="d-block text-muted mt-1">${data.libraries.length} libraries available</small>
                    </div>`;
            } else {
                container.innerHTML = `
                    <div class="plex-status disconnected">
                        <i class="bi bi-x-circle-fill"></i>
                        <strong>Not Connected</strong>
                        <small class="d-block text-muted mt-1">${data.error || 'Check server configuration'}</small>
                    </div>`;
            }
        })
        .catch(() => {
            document.getElementById('plexStatus').innerHTML = `
                <div class="plex-status disconnected">
                    <i class="bi bi-x-circle-fill"></i>
                    <strong>Connection Error</strong>
                    <small class="d-block text-muted mt-1">Unable to reach Plex server</small>
                </div>`;
        });
}

function loadLibraries() {
    fetch('/api/plex/libraries')
        .then(r => r.json())
        .then(data => {
            const container = document.getElementById('librariesList');
            if (data.success && data.libraries.length > 0) {
                container.innerHTML = data.libraries.map(lib => `
                    <div class="library-item">
                        <div class="library-icon ${lib.type}">
                            <i class="bi bi-${getLibraryIcon(lib.type)}"></i>
                        </div>
                        <div class="library-info">
                            <strong>${lib.title}</strong>
                            <small>${lib.type}</small>
                        </div>
                    </div>
                `).join('');
            } else if (data.success) {
                container.innerHTML = '<p class="text-muted text-center mb-0">No libraries configured</p>';
            } else {
                container.innerHTML = `<p class="text-muted text-center mb-0">${data.error || 'Unable to load libraries'}</p>`;
            }
        })
        .catch(() => {
            document.getElementById('librariesList').innerHTML = '<p class="text-danger text-center mb-0">Connection failed</p>';
        });
}

function getLibraryIcon(type) {
    const icons = { movie: 'film', show: 'tv', artist: 'music-note-beamed', photo: 'image' };
    return icons[type] || 'collection';
}

function setupDropZone() {
    const dropZone = document.getElementById('dropZone');
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(e => {
        dropZone.addEventListener(e, evt => { evt.preventDefault(); evt.stopPropagation(); });
    });
    ['dragenter', 'dragover'].forEach(e => {
        dropZone.addEventListener(e, () => dropZone.classList.add('dragover'));
    });
    ['dragleave', 'drop'].forEach(e => {
        dropZone.addEventListener(e, () => dropZone.classList.remove('dragover'));
    });
    dropZone.addEventListener('drop', e => handleFiles(e.dataTransfer.files));
}

function setupFileInput() {
    document.getElementById('fileInput').addEventListener('change', e => handleFiles(e.target.files));
}

function validateFile(file) {
    if (!uploadConfig) return { valid: true, error: null };
    if (file.size > uploadConfig.max_file_size) {
        return { valid: false, error: `"${file.name}" exceeds max size` };
    }
    const ext = file.name.split('.').pop().toLowerCase();
    if (!uploadConfig.allowed_extensions.includes(ext)) {
        return { valid: false, error: `".${ext}" not allowed` };
    }
    return { valid: true, error: null };
}

function handleFiles(files) {
    const valid = [], errors = [];
    Array.from(files).forEach(f => {
        const v = validateFile(f);
        v.valid ? valid.push(f) : errors.push(v.error);
    });
    if (errors.length) showToast('error', errors.join(', '));
    selectedFiles = valid;
    displaySelectedFiles();
    document.getElementById('uploadBtn').disabled = selectedFiles.length === 0;
}

function displaySelectedFiles() {
    const section = document.getElementById('selectedFilesSection');
    const list = document.getElementById('fileList');
    if (selectedFiles.length === 0) {
        section.style.display = 'none';
        return;
    }
    section.style.display = 'block';
    list.innerHTML = selectedFiles.map((f, i) => `
        <div class="file-item">
            <div class="file-info">
                <i class="bi bi-file-earmark-film"></i>
                <div class="file-details">
                    <strong>${f.name}</strong>
                    <small>${formatFileSize(f.size)}${f.size > CHUNKED_UPLOAD_THRESHOLD ? ' <span class="badge bg-info">Chunked</span>' : ''}</small>
                </div>
            </div>
            <button class="btn btn-outline-danger btn-sm" onclick="removeFile(${i})"><i class="bi bi-x"></i></button>
        </div>
    `).join('');
}

function removeFile(i) {
    selectedFiles.splice(i, 1);
    displaySelectedFiles();
    document.getElementById('uploadBtn').disabled = selectedFiles.length === 0;
}

async function startUpload() {
    if (selectedFiles.length === 0) return;
    const mediaType = document.getElementById('mediaTypeSelect').value;
    document.getElementById('uploadBtn').disabled = true;
    document.getElementById('uploadProgress').style.display = 'block';
    document.getElementById('cancelUploadBtn').style.display = 'inline-block';

    let successCount = 0, failCount = 0;
    for (let i = 0; i < selectedFiles.length; i++) {
        const file = selectedFiles[i];
        try {
            updateProgress((i / selectedFiles.length) * 100, `Uploading ${file.name}...`);
            if (file.size > CHUNKED_UPLOAD_THRESHOLD) {
                await uploadFileChunked(file, mediaType);
            } else {
                await uploadFileSimple(file, mediaType);
            }
            successCount++;
        } catch (error) {
            console.error('Upload failed:', error);
            failCount++;
            showToast('error', `Failed: ${file.name} - ${error.message}`);
        }
    }

    document.getElementById('uploadProgress').style.display = 'none';
    document.getElementById('cancelUploadBtn').style.display = 'none';
    document.getElementById('uploadBtn').disabled = false;

    if (successCount > 0) {
        showToast('success', `${successCount} file(s) uploaded successfully`);
        selectedFiles = [];
        displaySelectedFiles();
        document.getElementById('uploadBtn').disabled = true;
        loadJobs();
    }
}

async function uploadFileSimple(file, mediaType) {
    const formData = new FormData();
    formData.append('files', file);
    if (mediaType) formData.append('media_type', mediaType);

    const response = await fetch('/api/plex/import', { method: 'POST', body: formData });
    const data = await response.json();
    if (!data.success && !data.job_id) throw new Error(data.error || 'Upload failed');
    return data;
}

async function uploadFileChunked(file, mediaType) {
    const chunkSize = uploadConfig?.chunk_size || 10 * 1024 * 1024;
    const totalChunks = Math.ceil(file.size / chunkSize);

    const initResponse = await fetch('/api/plex/upload/init', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ filename: file.name, file_size: file.size, media_type: mediaType || null })
    });
    const initData = await initResponse.json();
    if (!initData.success) throw new Error(initData.error || 'Init failed');

    const uploadId = initData.upload_id;
    currentUpload = { uploadId, cancelled: false };

    for (let i = 0; i < totalChunks; i++) {
        if (currentUpload?.cancelled) throw new Error('Cancelled');
        const start = i * chunkSize;
        const chunk = file.slice(start, Math.min(start + chunkSize, file.size));
        const formData = new FormData();
        formData.append('upload_id', uploadId);
        formData.append('chunk_index', i);
        formData.append('chunk', chunk);

        const chunkResponse = await fetch('/api/plex/upload/chunk', { method: 'POST', body: formData });
        const chunkData = await chunkResponse.json();
        if (!chunkData.success) throw new Error(chunkData.error || 'Chunk failed');
        updateProgress(((i + 1) / totalChunks) * 100, `${file.name}: ${i + 1}/${totalChunks} chunks`);
    }

    const completeResponse = await fetch('/api/plex/upload/complete', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ upload_id: uploadId })
    });
    const completeData = await completeResponse.json();
    if (!completeData.success) throw new Error(completeData.error || 'Complete failed');
    currentUpload = null;
    return completeData;
}

function cancelCurrentUpload() {
    if (currentUpload) currentUpload.cancelled = true;
}

function updateProgress(percent, text) {
    if (percent !== null) document.getElementById('progressBar').style.width = percent + '%';
    if (text) document.getElementById('uploadStatusText').textContent = text;
}

function loadJobs() {
    fetch('/api/plex/jobs')
        .then(r => r.json())
        .then(data => {
            document.getElementById('jobsLoading').style.display = 'none';
            document.getElementById('jobsContent').style.display = 'block';
            const tbody = document.getElementById('jobsTableBody');
            const noJobs = document.getElementById('noJobs');

            if (!data.success || !data.jobs || data.jobs.length === 0) {
                tbody.innerHTML = '';
                noJobs.style.display = 'block';
                return;
            }

            noJobs.style.display = 'none';
            tbody.innerHTML = data.jobs.map(job => {
                const pct = job.total_files > 0 ? Math.round((job.processed_files / job.total_files) * 100) : 0;
                return `
                    <tr>
                        <td><code>${job.id.substring(0, 8)}...</code></td>
                        <td><span class="badge bg-secondary">${job.job_type}</span></td>
                        <td>${getStatusBadge(job.status)}</td>
                        <td>
                            <div class="d-flex align-items-center gap-2">
                                <div class="progress flex-grow-1" style="width: 80px;">
                                    <div class="progress-bar ${getProgressColor(job.status)}" style="width: ${pct}%"></div>
                                </div>
                                <small>${job.processed_files}/${job.total_files}</small>
                            </div>
                        </td>
                        <td><small>${formatDate(job.created_at)}</small></td>
                        <td>
                            <button class="btn btn-outline-primary btn-sm" onclick="viewJobDetails('${job.id}')"><i class="bi bi-eye"></i></button>
                            <button class="btn btn-outline-danger btn-sm" onclick="deleteJob('${job.id}')"><i class="bi bi-trash"></i></button>
                        </td>
                    </tr>`;
            }).join('');
        })
        .catch(() => {
            document.getElementById('jobsLoading').style.display = 'none';
            document.getElementById('jobsContent').style.display = 'block';
            document.getElementById('noJobs').style.display = 'block';
        });
}

function refreshJobs() { loadJobs(); }

function getStatusBadge(status) {
    const badges = {
        pending: 'bg-secondary', running: 'bg-primary', completed: 'bg-success',
        completed_with_errors: 'bg-warning', failed: 'bg-danger', cancelled: 'bg-secondary'
    };
    return `<span class="badge ${badges[status] || 'bg-secondary'}">${status}</span>`;
}

function getProgressColor(status) {
    const colors = { completed: 'bg-success', running: 'bg-primary', failed: 'bg-danger', completed_with_errors: 'bg-warning' };
    return colors[status] || 'bg-secondary';
}

function viewJobDetails(jobId) {
    fetch(`/api/plex/jobs/${jobId}`)
        .then(r => r.json())
        .then(data => {
            if (!data.success) return;
            const job = data.job;
            let items = '';
            if (job.items?.length) {
                items = `<h6 class="mt-3">Files</h6><div class="list-group">${job.items.map(item => `
                    <div class="list-group-item">
                        <strong>${item.original_filename}</strong>
                        <span class="float-end">${getStatusBadge(item.status)}</span>
                        ${item.error_message ? `<br><small class="text-danger">${item.error_message}</small>` : ''}
                    </div>`).join('')}</div>`;
            }
            document.getElementById('jobDetailsContent').innerHTML = `
                <p><strong>ID:</strong> ${job.id}</p>
                <p><strong>Type:</strong> ${job.job_type}</p>
                <p><strong>Status:</strong> ${getStatusBadge(job.status)}</p>
                <p><strong>Progress:</strong> ${job.processed_files}/${job.total_files}</p>
                <p><strong>Created:</strong> ${formatDate(job.created_at)}</p>
                ${items}`;
            new bootstrap.Modal(document.getElementById('jobDetailsModal')).show();
        });
}

function deleteJob(jobId) {
    if (!confirm('Delete this job?')) return;
    fetch(`/api/plex/jobs/${jobId}`, { method: 'DELETE' })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                showToast('success', 'Job deleted');
                loadJobs();
            } else {
                showToast('error', data.error || 'Delete failed');
            }
        });
}

function cleanupOldJobs() {
    if (!confirm('Remove completed jobs older than 30 days?')) return;
    const formData = new FormData();
    formData.append('days', 30);
    fetch('/api/plex/cleanup', { method: 'POST', body: formData })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                showToast('success', 'Cleanup started');
                setTimeout(loadJobs, 2000);
            } else {
                showToast('error', data.error || 'Cleanup failed');
            }
        });
}

function triggerManualScan() {
    fetch('/api/plex/scan', { method: 'POST' })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                showToast('success', `Scanned ${data.libraries?.length || 0} libraries`);
            } else {
                showToast('error', data.error || 'Scan failed');
            }
        });
}

function showToast(type, message) {
    const toast = document.getElementById(type + 'Toast');
    toast.querySelector('.toast-body').textContent = message;
    new bootstrap.Toast(toast).show();
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024, sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
}

function formatDate(d) {
    if (!d) return 'N/A';
    return new Date(d).toLocaleString();
}
</script>
{% endblock %}
