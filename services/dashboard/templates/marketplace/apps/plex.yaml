metadata:
  id: plex
  name: Plex Media Server
  category: media
  description: "Stream your personal media collection"
  icon: "ðŸŽ¬"
  version: "latest"
  author: "Plex Inc."
  tags: ["media", "streaming", "movies", "tv"]
  
docker:
  image: "plexinc/pms-docker:latest"
  container_name: "{{ APP_NAME }}"
  restart: always
  
  ports:
    - "{{ PORT }}:32400/tcp"
    - "3005:3005/tcp"
    - "8324:8324/tcp"
    - "32469:32469/tcp"
    - "1900:1900/udp"
    - "32410:32410/udp"
    - "32412:32412/udp"
    - "32413:32413/udp"
    - "32414:32414/udp"
  
  environment:
    TZ: "{{ TIMEZONE }}"
    PLEX_CLAIM: "{{ PLEX_CLAIM }}"
    ADVERTISE_IP: "{{ ADVERTISE_IP }}"
    PLEX_UID: "{{ PLEX_UID }}"
    PLEX_GID: "{{ PLEX_GID }}"
  
  volumes:
    - "{{ CONFIG_DIR }}:/config"
    - "{{ MEDIA_DIR }}:/media"
    - "{{ TRANSCODE_DIR }}:/transcode"
  
  networks:
    - "{{ NETWORK }}"

requirements:
  database: none
  storage: "50GB"
  memory: "2GB"
  cpu: "4"

configuration:
  variables:
    - name: APP_NAME
      label: "Application Name"
      type: string
      default: "plex"
      required: true
      validation: "^[a-z0-9-]+$"
    
    - name: PORT
      label: "Web UI Port"
      type: number
      default: 32400
      required: true
    
    - name: TIMEZONE
      label: "Timezone"
      type: string
      default: "America/New_York"
      required: true
    
    - name: PLEX_CLAIM
      label: "Plex Claim Token"
      type: string
      default: ""
      required: false
    
    - name: ADVERTISE_IP
      label: "Advertise IP"
      type: string
      default: "http://localhost:32400"
      required: false
    
    - name: PLEX_UID
      label: "Plex User ID"
      type: number
      default: 1000
      required: true
    
    - name: PLEX_GID
      label: "Plex Group ID"
      type: number
      default: 1000
      required: true
    
    - name: CONFIG_DIR
      label: "Config Directory"
      type: string
      default: "/var/lib/plex/config"
      required: true
    
    - name: MEDIA_DIR
      label: "Media Directory"
      type: string
      default: "/media"
      required: true
    
    - name: TRANSCODE_DIR
      label: "Transcode Directory"
      type: string
      default: "/var/lib/plex/transcode"
      required: true
    
    - name: NETWORK
      label: "Docker Network"
      type: string
      default: "homelab"
      required: true

setup:
  steps:
    - name: "Create directories"
      action: create_directories
      params:
        paths:
          - "{{ CONFIG_DIR }}"
          - "{{ TRANSCODE_DIR }}"
    
    - name: "Configure Caddy reverse proxy"
      action: update_caddyfile
      params:
        domain: "{{ DOMAIN }}"
        target: "http://{{ APP_NAME }}:32400"

health_check:
  endpoint: "http://localhost:{{ PORT }}/web"
  interval: 60s
  timeout: 30s
  retries: 3

documentation:
  readme: |
    # Plex Media Server Installation
    
    Access Plex at: http://localhost:{{ PORT }}/web
    
    ## Setup Instructions:
    1. Get your Plex claim token from: https://www.plex.tv/claim/
    2. Sign in with your Plex account
    3. Add your media libraries
    4. Configure remote access (optional)
    
    ## Media Directories:
    - Config: {{ CONFIG_DIR }}
    - Media: {{ MEDIA_DIR }}
    - Transcode: {{ TRANSCODE_DIR }}
  
  links:
    - name: "Plex Support"
      url: "https://support.plex.tv/"
    - name: "Get Claim Token"
      url: "https://www.plex.tv/claim/"
