# ğŸš€ NebulaCommand - READY FOR UBUNTU DEPLOYMENT

**All crash-loop issues resolved! Your homelab is ready to go live! ğŸ‰**

---

## âœ… **What We Fixed**

### **1. Missing Python Dependencies**
- **Problem:** Dashboard crashed with `ModuleNotFoundError: No module named 'structlog'`
- **Fix:** Added `structlog==24.1.0` to `services/dashboard/requirements.txt`
- **Status:** âœ… **FIXED**

### **2. Missing Node Dependencies**
- **Problem:** Discord & Stream bots crashed with `Cannot find package 'winston'`
- **Fix:** 
  - Added `winston` to both `package.json` files
  - Regenerated `package-lock.json` with `npm install`
- **Status:** âœ… **FIXED**

### **3. PowerDNS Port Conflict**
- **Problem:** Port 53 already in use by systemd-resolved (Ubuntu system DNS)
- **Fix:** 
  - Disabled PowerDNS service in `docker-compose.unified.yml`
  - Disabled PowerDNS postgres init script
- **Status:** âœ… **FIXED**

### **4. Missing Environment Variables**
- **Problem:** Services crash-looping due to undefined environment variables
- **Fix:** Created comprehensive validation script `scripts/setup-ubuntu-env.sh`
- **Status:** âœ… **READY TO VALIDATE**

---

## ğŸ“‹ **Ubuntu Deployment Steps**

### **Step 1: Sync Latest Code**

```bash
cd /home/evin/contain/HomeLabHub
git pull origin main
```

### **Step 2: Validate Environment**

```bash
./scripts/setup-ubuntu-env.sh
```

**This will:**
- âœ“ Check all 29 required environment variables
- âœ“ Show auto-generation commands for passwords/secrets
- âœ“ Tell you exactly which API keys to add manually
- âœ“ Exit with error if critical variables missing

**Required Manual Variables:**
```bash
# Dashboard
WEB_USERNAME=admin
WEB_PASSWORD=<your-secure-password>
DASHBOARD_API_KEY=<generate-this>
OPENAI_API_KEY=<from-openai>

# Discord Bot (âš ï¸ ALL 4 REQUIRED)
DISCORD_BOT_TOKEN=<from-discord-dev-portal>
DISCORD_CLIENT_ID=<from-discord-dev-portal>
DISCORD_CLIENT_SECRET=<from-discord-dev-portal>
DISCORD_APP_ID=<from-discord-dev-portal>  # âš ï¸ NEW REQUIREMENT

# Stream Bot (optional but recommended)
TWITCH_CLIENT_ID=<from-twitch>
TWITCH_CLIENT_SECRET=<from-twitch>
# ... (add others as needed)
```

### **Step 3: Rebuild Docker Images**

âš ï¸ **CRITICAL:** You MUST rebuild images to include new dependencies!

```bash
./scripts/rebuild-and-deploy.sh
```

**What this does:**
1. Stops all running containers
2. Rebuilds dashboard with `structlog`
3. Rebuilds discord-bot with `winston`
4. Rebuilds stream-bot with `winston`
5. Starts all services with health checks
6. Verifies deployment success

**Options:**
```bash
# Force complete rebuild (no cache)
./scripts/rebuild-and-deploy.sh --no-cache

# Rebuild specific services only
./scripts/rebuild-and-deploy.sh --services discord-bot stream-bot
```

### **Step 4: Verify Deployment**

```bash
# Check all services are running
docker compose -f docker-compose.unified.yml ps

# Run comprehensive diagnostics
./scripts/diagnose-ubuntu-crashloop.sh

# Check specific service logs
docker compose -f docker-compose.unified.yml logs -f discord-bot
docker compose -f docker-compose.unified.yml logs -f stream-bot
docker compose -f docker-compose.unified.yml logs -f homelab-dashboard
```

---

## ğŸ¯ **Expected Results**

After successful deployment, you should see:

âœ… **Dashboard:** Running at https://host.evindrake.net  
âœ… **Discord Bot:** Connected to Discord, ticket system active at https://bot.rig-city.com  
âœ… **Stream Bot:** Connected to Twitch/YouTube/Kick at https://stream.rig-city.com  
âœ… **rig-city.com:** Static website live and accessible  
âœ… **All services:** "healthy" status in docker ps  
âœ… **No crash-loops:** All containers running continuously  
âœ… **SSL certificates:** Auto-generated by Caddy

---

## ğŸ› ï¸ **Troubleshooting**

### **If services still crash-loop:**

```bash
# 1. Re-validate environment
./scripts/setup-ubuntu-env.sh

# 2. Check what's missing
./scripts/diagnose-ubuntu-crashloop.sh

# 3. View detailed logs
docker compose -f docker-compose.unified.yml logs discord-bot | tail -n 100
```

### **If "Cannot find module 'winston'" persists:**

```bash
# Rebuild with no cache
./scripts/rebuild-and-deploy.sh --no-cache
```

### **If dashboard shows "Module not found: structlog":**

```bash
# Rebuild dashboard specifically
./scripts/rebuild-and-deploy.sh --no-cache --services homelab-dashboard
```

---

## ğŸ“Š **Service Ports (Internal Network)**

All services bind to port 5000 internally, but Docker network isolation prevents conflicts:

| Service | Internal Port | External Access |
|---------|--------------|-----------------|
| Dashboard | 5000 | Caddy â†’ https://host.evindrake.net |
| Discord Bot | 5000 | Caddy â†’ https://bot.rig-city.com |
| Stream Bot | 5000 | Caddy â†’ https://stream.rig-city.com |
| MinIO | 9000/9001 | Direct access |
| Redis | 6379 | Internal only |
| PostgreSQL | 5432 | Internal only |

---

## ğŸ‰ **What You Can Do Now**

Once deployed successfully, you can:

### **1. Access rig-city.com**
Your public-facing website will be live at https://scarletredjoker.com and https://rig-city.com

### **2. Use Discord Ticket Bot**
- Create support tickets
- Manage server moderation
- Get go-live notifications for streamers

### **3. Use Stream Bot**
- Send Snapple Facts to your streamer buddies! ğŸ¥¤
- AI-powered chat moderation
- Custom commands and giveaways
- Multi-platform support (Twitch, YouTube, Kick)

### **4. Manage Everything from Dashboard**
- Monitor all services in real-time
- View logs and metrics
- AI-powered diagnostics with Jarvis
- DNS management via ZoneEdit

---

## ğŸ” **Security Reminders**

- âœ… Never commit `.env` file to git
- âœ… Use strong passwords (auto-generated ones are secure)
- âœ… Keep API keys secret
- âœ… Enable Ubuntu firewall: `sudo ufw allow 80,443/tcp`
- âœ… Regularly update: `git pull && ./scripts/rebuild-and-deploy.sh`

---

## ğŸ†˜ **Need Help?**

1. **Read:** `UBUNTU_DEPLOYMENT_GUIDE.md` (comprehensive docs)
2. **Validate:** `./scripts/setup-ubuntu-env.sh`
3. **Diagnose:** `./scripts/diagnose-ubuntu-crashloop.sh`
4. **Rebuild:** `./scripts/rebuild-and-deploy.sh`
5. **Check logs:** `docker compose logs [service-name]`

---

## ğŸ“š **Files Created/Updated**

- âœ… `services/dashboard/requirements.txt` - Added structlog
- âœ… `services/discord-bot/package.json` - Added winston
- âœ… `services/stream-bot/package.json` - Added winston
- âœ… `services/discord-bot/package-lock.json` - Regenerated
- âœ… `services/stream-bot/package-lock.json` - Regenerated
- âœ… `docker-compose.unified.yml` - Disabled PowerDNS
- âœ… `config/postgres-init/02-powerdns.sql.disabled` - Disabled init
- âœ… `scripts/rebuild-and-deploy.sh` - Comprehensive rebuild script
- âœ… `scripts/setup-ubuntu-env.sh` - Environment validator (updated)
- âœ… `UBUNTU_DEPLOYMENT_GUIDE.md` - Complete deployment guide
- âœ… `UBUNTU_DEPLOYMENT_READY.md` - This file!

---

**Everything is ready! Just follow the 4 steps above and you'll have:**
- âœ… rig-city.com live
- âœ… Discord ticket bot working
- âœ… Stream bot sending Snapple Facts
- âœ… Complete homelab dashboard
- âœ… All services healthy and monitored

**Good luck with your deployment! ğŸš€ğŸ’œ**
