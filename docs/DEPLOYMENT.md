# Deployment Guide

## Quick Start

### First-Time Setup
```bash
# 1. Run interactive setup wizard
./setup.sh

# 2. Deploy services
./deploy.sh start

# 3. Access dashboard
http://localhost:5000
# or https://host.evindrake.net (production)
```

## Deployment Commands

### setup.sh - Interactive Configuration
```bash
./setup.sh              # Full interactive setup
./setup.sh quick        # Quick start (minimal config)
./setup.sh validate     # Validate existing config
```

**What it does:**
- Prompts for all credentials (OpenAI, Discord, Home Assistant, etc.)
- Tests API keys before saving
- Generates secure database passwords
- Creates `.env` file
- Provides OAuth setup guidance

### deploy.sh - Service Management
```bash
./deploy.sh setup       # Quick setup (runs setup.sh)
./deploy.sh start       # Start all services
./deploy.sh stop        # Stop all services
./deploy.sh restart     # Restart all services
./deploy.sh status      # Check service status
./deploy.sh health      # Comprehensive health check
./deploy.sh logs        # View logs (-f to follow)
./deploy.sh backup      # Create backup
./deploy.sh restore     # Restore from backup
./deploy.sh deploy      # Full production deployment
```

**Features:**
- ✅ Self-healing (3 retry attempts with backoff)
- ✅ Port conflict resolution
- ✅ HTTP health checks (not just container status)
- ✅ Environment validation
- ✅ Automatic backup before deploy

## Environment Variables

### Required (Core Services)
```bash
# Database Passwords
JARVIS_DB_PASSWORD=<auto-generated>
DISCORD_DB_PASSWORD=<auto-generated>
STREAMBOT_DB_PASSWORD=<auto-generated>

# Web Authentication
WEB_USERNAME=admin
WEB_PASSWORD=<your-password>

# Security
DASHBOARD_API_KEY=<auto-generated>
DASHBOARD_SESSION_SECRET=<auto-generated>
```

### Optional (Features)

**Jarvis AI:**
```bash
AI_INTEGRATIONS_OPENAI_API_KEY=sk-...
```

**Home Assistant:**
```bash
HOME_ASSISTANT_URL=https://home.example.com
HOME_ASSISTANT_TOKEN=<long-lived-token>
```

**Discord Bot:**
```bash
DISCORD_BOT_TOKEN=<bot-token>
DISCORD_CLIENT_ID=<client-id>
DISCORD_CLIENT_SECRET=<client-secret>
```

**ZoneEdit DNS (will be replaced):**
```bash
ZONEEDIT_USERNAME=<username>
ZONEEDIT_PASSWORD=<password>
# OR
ZONEEDIT_API_TOKEN=<token>
```

## Production Deployment

### Ubuntu Homelab Setup
```bash
# 1. Clone repository
cd /home/evin/contain
git clone <repo-url> homelab-dashboard

# 2. Run setup
cd homelab-dashboard
./setup.sh

# 3. Deploy
./deploy.sh deploy

# 4. Configure Caddy reverse proxy
# (Automatic via domain management system)
```

### Replit → Ubuntu Sync
Auto-sync runs every 5 minutes via `deployment/sync-from-replit.sh`

**Manual sync:**
```bash
# On Ubuntu
cd /home/evin/contain/homelab-dashboard
git pull origin main
./deploy.sh restart
```

## Health Checks

### Automated Checks
```bash
./deploy.sh health
```

**Checks:**
- ✅ Environment variables set
- ✅ Required directories exist
- ✅ Services responding (HTTP 200)
- ✅ Database connectivity
- ✅ Redis connectivity

### Manual Verification
```bash
# Check containers
docker ps

# Check logs
./deploy.sh logs dashboard
./deploy.sh logs -f  # Follow all logs

# Test endpoints
curl http://localhost:5000/health
```

## Backup & Restore

### Create Backup
```bash
./deploy.sh backup
# Creates: backups/backup_YYYYMMDD_HHMMSS.tar.gz
# Includes: PostgreSQL dumps, .env, configs, data/
```

### Restore from Backup
```bash
./deploy.sh restore
# Lists available backups
# Select one to restore
# Automatically stops services, restores, restarts
```

## Troubleshooting

### Login Not Working
```bash
# Check if WEB_USERNAME/WEB_PASSWORD are set
./deploy.sh status

# Verify .env is loaded
docker-compose exec dashboard env | grep WEB_
```

### Services Won't Start
```bash
# Check for port conflicts
./deploy.sh health

# View detailed logs
./deploy.sh logs -f

# Try self-healing restart
./deploy.sh restart
```

### Database Connection Errors
```bash
# Check database status
docker ps | grep postgres

# Verify database passwords match
cat .env | grep DB_PASSWORD

# Restart database
./deploy.sh restart
```

### Changes Not Visible
```bash
# 1. Restart workflow (in Replit)
# 2. Hard refresh browser (Ctrl+Shift+R)
# 3. Check if Docker mounted correctly
docker-compose exec dashboard ls -la
```

## Security Considerations

### Production Checklist
- ✅ Change default WEB_PASSWORD
- ✅ Generate unique API keys (setup.sh does this)
- ✅ Enable HTTPS (Caddy automatic)
- ✅ Configure firewall (allow 80, 443, 53 for DNS)
- ✅ Regular backups (automated daily)
- ✅ Keep secrets out of git (use .env)

### Secret Management
```bash
# Never commit secrets!
# Check .gitignore includes:
.env
backups/
data/
*.log
```

## Multi-Domain Setup

### Configured Domains
- `host.evindrake.net` - Dashboard
- `plex.evindrake.net` - Plex Media Server
- `n8n.evindrake.net` - n8n Automation
- `vnc.evindrake.net` - VNC Desktop
- `home.evindrake.net` - Home Assistant
- `bot.rig-city.com` - Discord Bot
- `stream.rig-city.com` - Stream Bot
- `scarletredjoker.com` - Static Site

### Adding New Service
```bash
# 1. Add to docker-compose.unified.yml
# 2. Configure Caddy reverse proxy
# 3. Add DNS record (via dashboard or ZoneEdit)
# 4. Deploy
./deploy.sh deploy

# OR use Jarvis (after Phase 1):
"Jarvis, deploy new service on newservice.example.com"
```

## Monitoring

### Real-Time Monitoring
- Dashboard UI: System stats, container status
- Logs: `./deploy.sh logs -f`
- Health: `./deploy.sh health` (automated)

### Alerts
- Domain SSL expiration (30 days before)
- Service health failures
- Disk space warnings (when <10%)

## Performance Tuning

### Database
```bash
# Connection pooling (PostgreSQL)
POSTGRES_MAX_CONNECTIONS=100

# Dashboard connection pool
DB_POOL_SIZE=10
DB_MAX_OVERFLOW=5
```

### Redis
```bash
# Memory limit
REDIS_MAXMEMORY=256mb
REDIS_MAXMEMORY_POLICY=allkeys-lru
```

### Celery Workers
```bash
# Concurrent workers
CELERY_WORKERS=4
```

---

Last Updated: November 16, 2024
